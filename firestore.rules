rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is admin
    // TODO: Implement proper admin role checking when admin feature is added
    // For now, this is a placeholder that denies all admin-only operations
    function isAdmin() {
      return false;  // Will be updated when admin feature is implemented
      // Future implementation:
      // return isAuthenticated() &&
      //        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ============================================
    // USER PROFILES AND USER DATA
    // ============================================

    match /users/{userId} {
      // Users can only read and write their own profile
      allow read, write: if isOwner(userId);

      // ============================================
      // USER MATCHES (includes both active and completed)
      // ============================================

      match /matches/{matchId} {
        // Users can only read and write their own matches
        // matchId can be 'active' for current match, or timestamp for completed matches
        allow read, write: if isOwner(userId);
      }

      // ============================================
      // DEBUG LOGS (development/staging only)
      // ============================================

      match /debug_logs/{logId} {
        // Users can read and create their own debug logs
        // Note: Debug logging is disabled in production by default (client-side)
        allow read, create: if isOwner(userId);

        // Never allow updates or deletes (logs are immutable)
        allow update, delete: if false;
      }

      // ============================================
      // ERROR LOGS (always enabled, even in production)
      // ============================================

      match /errors/{errorId} {
        // Users can read and create their own error logs
        allow read, create: if isOwner(userId);

        // Never allow updates or deletes (logs are immutable)
        allow update, delete: if false;
      }
    }

    // ============================================
    // FUTURE: SHARED MATCHES
    // ============================================
    // This section is prepared for future match-sharing functionality
    // Currently not in use, but structure is ready for implementation

    // match /sharedMatches/{shareId} {
    //   allow read: if isAuthenticated() && request.auth.uid in resource.data.sharedWith;
    //   allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    //   allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    // }

    // ============================================
    // DENY ALL OTHER PATHS
    // ============================================

    // Explicitly deny access to any undeclared paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

